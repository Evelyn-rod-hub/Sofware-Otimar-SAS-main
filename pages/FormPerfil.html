<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Perfil</title>
    <link rel="stylesheet" href="../css/styleformperfil.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* CSS se pegará aquí */
    </style>
</head>

<body>
    <div class="page-wrapper">
        <aside class="sidebar">
            <img class="logo" src="../Img/logo_otimar.png" alt="">
            <div class="sidebar-header">
                Mi Cuenta
            </div>
            <nav class="sidebar-nav">
                <ul>
                    <li class="active">
                        <a href="#">
                            <i class="fas fa-user"></i>
                            <span>Mi perfil</span>
                            <i class="fas fa-chevron-right arrow"></i>
                        </a>
                    </li>
                    <li>
                        <a href="#">
                            <i class="fas fa-plane"></i>
                            <span>Mis viajes</span>
                            <i class="fas fa-chevron-right arrow"></i>
                        </a>
                    </li>
                    <li>
                        <a href="#">
                            <i class="fas fa-wallet"></i>
                            <span>Billetera virtual</span>
                            <i class="fas fa-chevron-right arrow"></i>
                        </a>
                    </li>
                    <li>
                        <a href="#">
                            <i class="fas fa-sign-out-alt"></i>
                            <span>Cerrar sesión</span>
                        </a>
                    </li>
                </ul>
            </nav>
        </aside>

        <main class="main-content">
            <div class="main-header">
                Mi perfil
            </div>

            <div class="profile-card">
                <h2>
                    <span class="avatar-initials">E</span>
                    Datos personales
                </h2>
                <form id="personalDataForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="nombre">Nombre</label>
                            <div class="input-field-group">
                                <input type="text" id="nombre" placeholder="Escribe los nombres aquí">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="apellidos">Apellidos</label>
                            <div class="input-field-group">
                                <input type="text" id="apellidos" placeholder="Escribe los apellidos aquí">
                            </div>
                            <span class="error-message" id="apellidos-error" data-error-message="El apellido es requerido.">El apellido es
                                requerido.</span>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="tipoDocumento">Tipo de documento</label>
                            <div class="input-field-group">
                                <select id="tipoDocumento">
                                    <option value="">Selecciona...</option>
                                    <option value="">Cédula</option>
                                    <option value="">Tarjeta de identidad</option>
                                    <option value="">Registro Civil</option>
                                    <option value="">Cédula de extranjería</option>
                                    <option value="">Pasaporte</option>
                                    <option value="">PPT</option>
                                    <option value="">DNI</option>
                                    <option value="">CPF</option>
                                </select>
                            </div>
                            <span class="error-message" id="tipoDocumento-error" data-error-message="Selecciona un tipo de documento.">Selecciona un
                                tipo de documento.</span>
                        </div>
                        <div class="form-group">
                            <label for="numeroDocumento">Número de documento</label>
                            <div class="input-field-group">
                                <input type="text" id="numeroDocumento" placeholder="Escribe tu documento aquí">
                            </div>
                            <span class="error-message" id="numeroDocumento-error"
                                data-error-message="Ingresa un número de documento válido.">Ingresa un número de documento válido.</span>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Fecha de nacimiento</label>
                            <div class="input-field-group error-border" id="fechaNacimiento-group">
                                <div class="date-fields">
                                    <input type="text" placeholder="DD" style="width: 40px;">
                                    <span>/</span>
                                    <input type="text" placeholder="MM" style="width: 40px;">
                                    <span>/</span>
                                    <input type="text" placeholder="AAAA" style="width: 60px;">
                                </div>
                            </div>
                            <span class="error-message" id="fechaNacimiento-error"
                                data-error-message="Ingresa una fecha de nacimiento válida (DD/MM/AAAA).">Ingresa una fecha de nacimiento válida
                                (DD/MM/AAAA).</span>
                        </div>
                        <div class="form-group">
                            <label for="nacionalidad">Nacionalidad</label>
                            <div class="input-field-group">
                                <input type="text" id="nacionalidad" placeholder="Escribe tu nacionalidad aquí">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Genero</label>
                            <div class="gender-options">
                                <div class="gender-option">
                                    <input type="radio" id="masculino" name="genero" value="masculino" checked>
                                    <label for="masculino">Masculino</label>
                                </div>
                                <div class="gender-option">
                                    <input type="radio" id="femenino" name="genero" value="femenino">
                                    <label for="femenino">Femenino</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <h3>Datos de contacto</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="correoElectronico">Correo Electrónico</label>
                            <div class="input-field-group" id="correoElectronico-group">
                                <input type="email" id="correoElectronico" value="" placeholder="Escribe tu correo electrónico aquí">
                            </div>
                            <span class="error-message" id="correoElectronico-error"
                                data-error-message="Ingresa un correo electrónico válido.">Ingresa un correo electrónico válido.</span>
                        </div>
                        <div class="form-group">
                            <label for="phoneCountryCodeSelect">Teléfono</label>
                            <div class="phone-input-group" id="phoneNumberInput-group">
                                <select id="phoneCountryCodeSelect">
                                    <option value="" data-country-code="co">Selecciona...</option>
                                    <option value="+57" data-country-code="co">+57 (Colombia)</option>
                                    <option value="+55" data-country-code="br">+55 (Brasil)</option>
                                    <option value="+51" data-country-code="pe">+51 (Perú)</option>
                                </select>
                                <img id="countryFlag" src="https://flagcdn.com/w20/co.png" alt="Bandera de Colombia">
                                <input type="tel" id="phoneNumberInput" value="" placeholder="Número de teléfono aquí">
                            </div>
                            <span class="error-message" id="phoneNumberInput-error"
                                data-error-message="Ingresa un número de teléfono válido.">Ingresa un número de teléfono válido.</span>
                        </div>
                    </div>

                    <div class="button-group">
                        <button type="submit" class="button primary">Actualizar</button>
                    </div>
                </form>
            </div>

            <div class="profile-card">
                <h2>Cambiar Contraseña</h2>
                <form id="changePasswordForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="newPassword">Contraseña nueva</label>
                            <div class="input-field-group">
                                <input type="password" id="newPassword" placeholder="Ingresa tu contraseña nueva">
                                <span class="password-toggle">Mostrar</span>
                            </div>
                            <span class="error-message" id="newPassword-error"
                                data-error-message="La contraseña debe tener al menos 6 caracteres.">La contraseña debe tener al menos 6
                                caracteres.</span>
                        </div>
                        <div class="form-group">
                            <label for="confirmPassword">Confirmar contraseña nueva</label>
                            <div class="input-field-group">
                                <input type="password" id="confirmPassword" placeholder="Confirma tu contraseña nueva">
                                <span class="password-toggle">Mostrar</span>
                            </div>
                            <span class="error-message" id="confirmPassword-error"
                                data-error-message="Las contraseñas no coinciden.">Las contraseñas no coinciden.</span>
                        </div>
                    </div>

                    <div class="button-group">
                        <button type="submit" class="button primary">Cambiar contraseña</button>
                    </div>
                </form>
            </div>
        </main>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- Funciones de Validación (Reglas generales) ---
            const ValidationRules = {
                isEmpty: (value) => value.trim() === '',
                isValidEmail: (value) => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value),
                isMinLength: (value, min) => value.length >= min,
                isValidPassword: (value) => ValidationRules.isMinLength(value, 6), // Contraseña de al menos 6 caracteres
                doPasswordsMatch: (password, confirmPassword) => password === confirmPassword,
                isNumeric: (value) => /^\d+$/.test(value),
                // Valida que sea una fecha real y no en el futuro
                isValidDate: (dayStr, monthStr, yearStr) => {
                    const day = parseInt(dayStr, 10);
                    const month = parseInt(monthStr, 10);
                    const year = parseInt(yearStr, 10);

                    if (isNaN(day) || isNaN(month) || isNaN(year)) return false;

                    const date = new Date(year, month - 1, day);
                    const today = new Date();
                    today.setHours(0, 0, 0, 0); // Reset time for comparison

                    // Check if date components match (prevents invalid dates like Feb 30)
                    // And if the date is not in the future
                    return date.getFullYear() === year &&
                        date.getMonth() === month - 1 &&
                        date.getDate() === day &&
                        date <= today; // Ensures date is not in the future
                },
                isSelectSelected: (value) => value !== '' // For dropdowns
            };

            // --- Función principal de validación para un campo ---
            // inputElement puede ser un solo elemento o un NodeList (para fecha)
            function validateField(inputElement, errorSpan, inputGroup, rules) {
                let isValid = true;
                let errorMessage = errorSpan.dataset.errorMessage || 'Campo inválido.'; // Mensaje por defecto

                // Para campos de fecha, inputElement será un NodeList de 3 inputs
                const isDateInputGroup = inputElement instanceof NodeList || inputElement instanceof HTMLCollection;

                let actualValue;
                if (isDateInputGroup) {
                    const day = inputElement[0].value;
                    const month = inputElement[1].value;
                    const year = inputElement[2].value;
                    actualValue = `${day}/${month}/${year}`; // Formato para chequeo de vacío
                } else {
                    actualValue = inputElement.value;
                }

                // 1. Validar 'required' primero
                if (rules.includes('required') && ValidationRules.isEmpty(actualValue)) {
                    isValid = false;
                    errorMessage = errorSpan.dataset.errorMessage || 'Este campo es requerido.';
                } else {
                    // 2. Aplicar otras reglas solo si el campo no está vacío o no es requerido
                    for (const rule of rules) {
                        if (rule === 'email' && !ValidationRules.isValidEmail(actualValue)) {
                            isValid = false;
                            errorMessage = 'Ingresa un correo electrónico válido.';
                            break;
                        }
                        if (rule === 'password' && !ValidationRules.isValidPassword(actualValue)) {
                            isValid = false;
                            errorMessage = 'La contraseña debe tener al menos 6 caracteres.';
                            break;
                        }
                        if (rule === 'numeric' && !ValidationRules.isNumeric(actualValue)) {
                            isValid = false;
                            errorMessage = 'Solo se permiten números.';
                            break;
                        }
                        if (rule === 'date' && isDateInputGroup) {
                            const day = inputElement[0].value;
                            const month = inputElement[1].value;
                            const year = inputElement[2].value;
                            if (!ValidationRules.isValidDate(day, month, year)) {
                                isValid = false;
                                errorMessage = 'Ingresa una fecha válida y no futura (DD/MM/AAAA).';
                                break;
                            }
                        }
                        if (rule === 'selectRequired' && !ValidationRules.isSelectSelected(actualValue)) {
                            isValid = false;
                            errorMessage = 'Selecciona una opción.';
                            break;
                        }
                    }
                }

                // 3. Manejo especial para la confirmación de contraseña
                if (inputElement.id === 'confirmPassword' && isValid) {
                    const newPasswordInput = document.getElementById('newPassword');
                    if (!ValidationRules.doPasswordsMatch(newPasswordInput.value, actualValue)) {
                        isValid = false;
                        errorMessage = 'Las contraseñas no coinciden.';
                    }
                }

                // --- Mostrar/Ocultar errores y bordes ---
                if (!isValid) {
                    errorSpan.textContent = errorMessage;
                    errorSpan.style.display = 'block';
                    inputGroup.classList.add('error-border');
                } else {
                    errorSpan.style.display = 'none';
                    inputGroup.classList.remove('error-border');
                }
                return isValid;
            }

            // --- Configuración centralizada de campos a validar ---
            const validationConfig = [
                // Datos personales
                { id: 'apellidos', group: 'apellidos-group', error: 'apellidos-error', rules: ['required'] },
                { id: 'tipoDocumento', group: 'tipoDocumento-group', error: 'tipoDocumento-error', rules: ['required', 'selectRequired'] }, // Para select
                { id: 'numeroDocumento', group: 'numeroDocumento-group', error: 'numeroDocumento-error', rules: ['required', 'numeric'] },
                { id: 'fechaNacimiento', group: 'fechaNacimiento-group', error: 'fechaNacimiento-error', rules: ['required', 'date'] }, // Validará el grupo de inputs de fecha
                { id: 'correoElectronico', group: 'correoElectronico-group', error: 'correoElectronico-error', rules: ['required', 'email'] },
                { id: 'phoneNumberInput', group: 'phoneNumberInput-group', error: 'phoneNumberInput-error', rules: ['required', 'numeric'] },

                // Cambiar Contraseña
                { id: 'newPassword', group: 'newPassword-group', error: 'newPassword-error', rules: ['required', 'password'] },
                { id: 'confirmPassword', group: 'confirmPassword-group', error: 'confirmPassword-error', rules: ['required', 'password'] },
            ];

            // --- Adjuntar validadores a los campos (on blur y on input/change) ---
            validationConfig.forEach(config => {
                let inputElements;
                if (config.id === 'fechaNacimiento') {
                    inputElements = document.querySelectorAll(`#${config.group} input`);
                    // Añadir una clase a cada parte de la fecha para facilitar la selección en validateField
                    inputElements.forEach(el => el.classList.add('date-part'));
                } else if (config.id === 'tipoDocumento') {
                    inputElements = document.getElementById(config.id);
                } else {
                    inputElements = document.getElementById(config.id);
                }

                const inputGroup = document.getElementById(config.group);
                const errorSpan = document.getElementById(config.error);

                if (!inputElements || !inputGroup || !errorSpan) {
                    console.warn(`Elementos no encontrados para el ID: ${config.id}. Revisa el HTML.`);
                    return; // Skip if elements are not found
                }

                // Adjuntar event listeners
                if (inputElements instanceof NodeList || inputElements instanceof HTMLCollection) { // Para grupo de inputs (ej. fecha)
                    inputElements.forEach(el => {
                        el.addEventListener('blur', () => validateField(inputElements, errorSpan, inputGroup, config.rules));
                        el.addEventListener('input', () => validateField(inputElements, errorSpan, inputGroup, config.rules));
                    });
                } else { // Para input o select individual
                    inputElements.addEventListener('blur', () => validateField(inputElements, errorSpan, inputGroup, config.rules));
                    // Validación en tiempo real (on input/change) para tipos específicos
                    if (['text', 'email', 'password', 'tel'].includes(inputElements.type) || inputElements.tagName === 'SELECT') {
                        inputElements.addEventListener('input', () => validateField(inputElements, errorSpan, inputGroup, config.rules));
                    }
                }
            });


            // --- Validación al enviar el formulario ---
            const personalDataForm = document.getElementById('personalDataForm');
            const changePasswordForm = document.getElementById('changePasswordForm');

            if (personalDataForm) {
                personalDataForm.addEventListener('submit', function (event) {
                    event.preventDefault(); // Evita el envío por defecto del formulario

                    let isFormValid = true;
                    // Itera sobre la configuración de validación para validar todos los campos de este formulario
                    validationConfig.forEach(config => {
                        const inputElement = document.getElementById(config.id);
                        // Asegurarse de que el campo pertenece a este formulario
                        if (personalDataForm.contains(inputElement)) {
                            const inputGroup = document.getElementById(config.group);
                            const errorSpan = document.getElementById(config.error);
                            let currentFieldValid;

                            if (config.id === 'fechaNacimiento') {
                                const dateInputs = document.querySelectorAll(`#${config.group} input`);
                                currentFieldValid = validateField(dateInputs, errorSpan, inputGroup, config.rules);
                            } else {
                                currentFieldValid = validateField(inputElement, errorSpan, inputGroup, config.rules);
                            }

                            if (!currentFieldValid) {
                                isFormValid = false;
                            }
                        }
                    });

                    if (isFormValid) {
                        console.log('Formulario "Datos personales" válido. Listo para enviar.');
                        // Aquí podrías enviar los datos del formulario "Datos personales" (ej. con fetch/AJAX)
                        // event.target.submit(); // Si quieres un envío tradicional
                    } else {
                        console.log('Errores en el formulario "Datos personales".');
                        // Opcional: Desplazarse al primer error visible
                        const firstError = personalDataForm.querySelector('.error-message[style*="display: block"]');
                        if (firstError) {
                            firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    }
                });
            }

            if (changePasswordForm) {
                changePasswordForm.addEventListener('submit', function (event) {
                    event.preventDefault();

                    let isFormValid = true;
                    validationConfig.forEach(config => {
                        const inputElement = document.getElementById(config.id);
                        if (changePasswordForm.contains(inputElement)) {
                            const inputGroup = document.getElementById(config.group);
                            const errorSpan = document.getElementById(config.error);
                            const currentFieldValid = validateField(inputElement, errorSpan, inputGroup, config.rules);
                            if (!currentFieldValid) {
                                isFormValid = false;
                            }
                        }
                    });

                    if (isFormValid) {
                        console.log('Formulario "Cambiar Contraseña" válido. Listo para enviar.');
                        // Aquí podrías enviar los datos del formulario "Cambiar Contraseña"
                    } else {
                        console.log('Errores en el formulario "Cambiar Contraseña".');
                        const firstError = changePasswordForm.querySelector('.error-message[style*="display: block"]');
                        if (firstError) {
                            firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    }
                });
            }

            // --- Script para la bandera del país (mantener de la mejora anterior) ---
            const phoneCountryCodeSelect = document.getElementById('phoneCountryCodeSelect');
            const countryFlagImg = document.getElementById('countryFlag');

            function updateFlag() {
                const selectedOption = phoneCountryCodeSelect.options[phoneCountryCodeSelect.selectedIndex];
                const countryCode = selectedOption.getAttribute('data-country-code');
                const countryNameMatch = selectedOption.textContent.match(/\((.*?)\)/);
                const countryName = countryNameMatch ? countryNameMatch[1] : 'país';

                if (countryCode) {
                    countryFlagImg.src = `https://flagcdn.com/w20/${countryCode}.png`;
                    countryFlagImg.alt = `Bandera de ${countryName}`;
                } else {
                    countryFlagImg.src = "";
                    countryFlagImg.alt = "Bandera del país";
                }
            }
            updateFlag(); // Llamada inicial
            phoneCountryCodeSelect.addEventListener('change', updateFlag);

            // --- Script para mostrar/ocultar contraseña (mantener de la mejora anterior) ---
            document.querySelectorAll('.password-toggle').forEach(toggle => {
                toggle.addEventListener('click', function () {
                    const input = this.previousElementSibling;
                    if (input.type === 'password') {
                        input.type = 'text';
                        this.textContent = 'Ocultar';
                    } else {
                        input.type = 'password';
                        this.textContent = 'Mostrar';
                    }
                });
            });

        }); // Fin de DOMContentLoaded
    </script>
</body>

</html>